 
# Tornado UI Spike
This folder contains the POC of a modern technology stack that could be used 
to implement icingaweb2 modules.

The objective is to prove how new technologies can be used to develop applications 
that can be deployed both as independent Single Page Application and as icingaweb2 modules.

The source code is split into three different components that together compose
a full working demo of the proposed stack. 

 
## DTO
The __dto__ component contains the 
[Data Transfer Object](https://en.wikipedia.org/wiki/Data_transfer_object) definitions
to carry data between processes. 

These DTOs are the structures exposed by the REST endpoints of the Tornado backend and are 
consumed by the Tornado UI frontend.

The object structures are defined in the Rust programming language and built as Rust crate.
Also, at build time, [wasm-bindgen](https://github.com/rustwasm/wasm-bindgen) is used 
to generate the Typescript definitions of the defined DTOs.

These Typescript definitions will be imported by the frontend to provide compile-time type safety.

### DTO crate dependencies:
The build process of the __dto__ crate requires:  
- rustc
- wasm-bindgen


### Build the DTOs:
To build the __dto__, use the provided `ui/dto/build.sh` script.
It will:
- build the Rust crate using `cargo`
- generate into the `ui/dto/pkg` directory the Typescript definitions for the DTOs.


## Backend
The __backend__ is a plain Rust library that defines the REST endpoints consumed by the frontend.
It imports the __dto__ crate and exposes REST endpoints that receive and produce DTOs 
as defined in the __dto__ crate itself.

The __backend__ crate is imported and used by the Tornado engine.


## Frontend

The __frontend__ is a self contained SPA 
([Single Page Application](https://en.wikipedia.org/wiki/Single-page_application)).

The development is based on the [Vue.js](https://vuejs.org/) framework and 
the project is generated and managed by [Vue CLI](https://cli.vuejs.org/).

The source code is written in [Typescript](https://www.typescriptlang.org/). 
As it uses the DTO Typescript definitions generated by the __dto__ crate, it provides 
compile-time type checking to assure that the calls to the __backend__
always use the correct data format.  


### Frontend built time dependencies:
The build process of the __frontend__ depends on the following components that have to be 
provided by the build machine:  
- nodejs 10.x 
- Vue CLI 3 globally installed (only for project scaffolding)
- chrome (required for unit and e2e tests execution)

Please, note that these dependencies are required only at build time. At runtime,
instead, the only dependency is an HTTP server to serve the static resources 
produced by the build.
 

### Build the Frontend:
To build the __frontend__, it is enough to execute the canonical `npm run build` command on a terminal 
into the `ui/frontend` folder.

Anyway, the complete build process, as it should be performed on a CI system,
involves many steps like cleaning and downloading the dependencies, 
execute the lint checks, run the unit and e2e tests and,
finally, build the artefacts.

All of these steps are executed, in the correct order, by the provided
`ui/frontend/build.sh` script. 
When executed, it will:
1. Copy the dto.ts files from the `ui/dto/pkg` folder 
   to the `ui/frontend/src/generated` local path
1. execute the lint checks
1. execute the unit tests
1. execute the e2e tests
1. build the package and store the produced artefacts into the `ui/frontend/dist` folder


## Global build
The `ui/build.sh` script triggers the build process of all the UI related components.  


## Integration with Icingaweb2
At the end of the build process of the __frontend__, the `ui/frontend/dist` folder
contains the static HTTP resources that compose the Tornado UI frontend SPA.

To render it as an Icingaweb2 module, simply copy the content of the `ui/frontend/dist/js`
directory into the `/src/tornado/public/img` folder of the 
__icingaweb2-module-tornado__.

This strategy foresees that the javascript files are deployed into the `public/img`
subpath of the Icingaweb2 module; this is workaround forced by the fact that Icingaweb2
makes public only files into that folder (to be investigated further).
 

This process has also many drawbacks like, for example, the fact that the files 
have to be manually copied; however, this is only for the scope of the POC. 
The build and deployment procedure for production use are outside the 
scope of this POC.